#!/usr/bin/python3
#
# xml2smalltalk
#

import sys, xml.sax
import libs.commandlib 

class Element:
    def __init__(self, name, attributes):
        self.name = name
        self.attributes = attributes
        self.children = []
        self.parent = None
        self.text = None

    def addChild(self, child):
        self.children.append(child)
        child.parent = self

    def __repr__(self):
        return '['+self.name+']'

class XMLHandler(xml.sax.ContentHandler):
    def __init__(self):
        self.current = None

    def startElement(self, name, attributes):
        newElement = Element(name, attributes)
        if self.current is not None:
            self.current.addChild(newElement)
        self.current = newElement

    def endElement(self, tag):
        if self.current.parent is not None:
            self.current = self.current.parent

    def characters(self, content):
        if content.strip() != '':
            self.current.text = content

class XMLTool(libs.commandlib.CommandLineTool):
    def __init__(self,):
        super().__init__()
        self.applicationName = 'xml2smalltalk'

    def help(self, *args):
        self.warn(*args)
        self.warn('xml2smalltalk - converts xml to Smalltalk code')
        self.warn('xml2smalltalk [FILE, ...]')
        self.warn('Reads input files and writes Smalltalk code to stdout.')
        sys.exit(2)

    def processArguments(self, files):
        if len(files) == 0:
            self.error('no input files')
        else:
            for file in files:
                self.processFile(file)

    def processFile(self, file):
        handler = XMLHandler()
        parser = xml.sax.make_parser()
        parser.setFeature(xml.sax.handler.feature_namespaces, False)
        parser.setContentHandler(handler)
        parser.parse(file)
        self.traverse(handler.current, indent=0)

    def traverse(self, element, indent):
        self.emit("<", element.name, indent=indent)
        self.emitAttributes(element.attributes.items(), indent)
        self.emit('>')
        if len(element.children) == 0:
            if element.text is not None:
                self.emit(element.text)
            self.emit('</', element.name, '>\n')
        else:
            self.emit('\n')
            for each in element.children:
                self.traverse(element=each, indent=indent+1)
            self.emit('</', element.name, '>\n', indent=indent)

    def emit(self, *arguments, indent=0):
        print('  ' * indent, *arguments, sep='', end='')

    def emitAttributes(self, attributes, indent):
        for key, value in attributes:
            self.emit(' ', key, '="', value, '"')

if __name__ == '__main__':
    XMLTool().processCommandLine()

