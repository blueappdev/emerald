#!/usr/bin/python3

# unpackexcel
#
# Unpack an xlsx Excel file for the purpose of analyzing it.
#

import sys, zipfile, os.path, shutil
import libs.xml.formatting

class ExcelUnpacker:
    def warning(self, *messages):
        print(*messages)

    def error(self, *messages):
        self.warning(*messages)
        sys.exit(2)

    def processCommandLine(self, argv):
        self.processArguments(argv[1:])
 
    def processArguments(self, arguments):
        for filename in arguments:
            if not filename.endswith('.xlsx'):
                filename = filename + '.xlsx'
            self.currentFilename = filename
            self.processCurrentFilename()

    def processCurrentFilename(self):
        print('Process', self.currentFilename)
        self.unzipCurrentFilename()
        self.formatFiles()

    def unzipCurrentFilename(self):
        self.currentRootName, ext = os.path.splitext(self.currentFilename)
        if ext != '.xlsx':
            self.error('Only xlsx files are supported')
        if os.path.exists(self.currentRootName):
            shutil.rmtree(self.currentRootName)
        with zipfile.ZipFile(self.currentFilename, 'r') as zip:
            zip.extractall(self.currentRootName)

    def formatFiles(self):
        for root, dirs, files in os.walk(self.currentRootName):
            for file in files:
                file = os.path.join(root, file)
                self.formatFile(file)

    def formatFile(self, file):
        print('    Format', file)
        with open(file) as input:
            with open(file+'_formatted', 'w') as output:
                libs.xml.formatting.XMLFormatter().process(input, output)
        os.rename(file+'_formatted', file)

if __name__ == '__main__':
    ExcelUnpacker().processCommandLine(sys.argv)
 
